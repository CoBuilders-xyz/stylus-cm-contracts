# Stylus Cache Manager Contracts

This repository contains the smart contracts for the Stylus Cache Manager Automation system. The repository is part of the [arb-research](https://github.com/ifqbuilder/arb-research) monorepo.

## Overview

The Stylus Cache Manager Automation system consists of two main contracts:

1. **CacheManagerAutomation**: The core contract that handles the automation of cache management operations in the Stylus ecosystem.
2. **BiddingEscrow**: A specialized escrow contract based on OpenZeppelin's Escrow implementation.

### CacheManagerAutomation

The CacheManagerAutomation contract serves as the primary interface for managing cache operations in the Stylus system. It provides functionality for:

- Managing cache entries
- Handling automation tasks
- Coordinating with the escrow system for bidding operations
- Maintaining cache state and validity

Key features include:

- Automated cache management
- Bidding system integration
- State validation and updates
- Security controls and access management

### BiddingEscrow

The BiddingEscrow contract is built upon OpenZeppelin's standard Escrow contract implementation, with one key addition:

- `withdrawForBid`: A specialized withdrawal function specifically designed for our bidding system use case

The BiddingEscrow contract maintains the security and reliability of the standard OpenZeppelin implementation while adding the necessary functionality for our bidding mechanism.

## Project Structure

```
contracts/
‚îú‚îÄ‚îÄ core/                    # Core contract implementations
‚îÇ   ‚îú‚îÄ‚îÄ CacheManagerAutomation.sol
‚îÇ   ‚îî‚îÄ‚îÄ BiddingEscrow.sol
‚îú‚îÄ‚îÄ interfaces/              # Contract interfaces
‚îÇ   ‚îú‚îÄ‚îÄ ICacheManagerAutomation.sol
‚îÇ   ‚îî‚îÄ‚îÄ IExternalContracts.sol
‚îî‚îÄ‚îÄ mocks/                   # Mock contracts for testing

abis/                        # External Contract ABIs
‚îî‚îÄ‚îÄ external/                # External contract ABIs
    ‚îú‚îÄ‚îÄ cacheManager.abi.json
    ‚îî‚îÄ‚îÄ arbWasmCache.abi.json

config/                      # Configuration files
‚îú‚îÄ‚îÄ networks.ts              # Network configurations
‚îú‚îÄ‚îÄ constants.ts             # Contract constants
‚îú‚îÄ‚îÄ deployment-config.ts     # Deployment configurations
‚îî‚îÄ‚îÄ abis.ts                  # External ABI management utilities

scripts/
‚îú‚îÄ‚îÄ deploy/                  # Deployment scripts
‚îÇ   ‚îî‚îÄ‚îÄ deploy-cache-manager-automation.ts
‚îî‚îÄ‚îÄ utils/                   # Utility scripts
    ‚îú‚îÄ‚îÄ generate-types.ts    # Generate TypeScript types for external contracts
    ‚îî‚îÄ‚îÄ verify-abis.ts       # Verify external ABI compatibility

test/                        # Test files
‚îú‚îÄ‚îÄ CacheManagerAutomation.test.ts
‚îú‚îÄ‚îÄ CacheManager.test.ts
‚îî‚îÄ‚îÄ helpers.ts               # Test utilities

build/                       # Build artifacts (generated by Hardhat)
‚îú‚îÄ‚îÄ artifacts/               # Hardhat compilation artifacts (includes our contract ABIs)
‚îî‚îÄ‚îÄ typechain-types/         # Generated TypeScript types for all contracts
    ‚îú‚îÄ‚îÄ contracts/           # Types for our contracts (auto-generated by Hardhat)
    ‚îî‚îÄ‚îÄ external/            # Types for external contracts (generated by our script)
```

## Development

### Prerequisites

- Node.js >= 18
- npm or yarn

### Installation

1. Clone the repository and install dependencies:

```bash
npm install
```

2. Copy environment variables:

```bash
cp .env.example .env
# Edit .env with your configuration
```

### Available Scripts

```bash
# Compile contracts (also generates types for our contracts)
npm run compile

# Run all tests
npm run test

# Run specific tests
npm run test:cma    # CacheManagerAutomation tests
npm run test:cm     # CacheManager tests

# Deploy contracts
npm run deploy:local    # Deploy to local network
npm run deploy:sepolia  # Deploy to Arbitrum Sepolia

# External Contract Management
npm run types:external  # Generate TypeScript types for external contracts
npm run abis:verify     # Verify external ABI compatibility

# Complete build process
npm run build          # Compile + Generate External Types

# Clean build artifacts
npm run clean

# Generate TypeScript types (for our contracts)
npm run typechain
```

## Type System & ABI Management

This repository uses a **simplified, efficient approach** for managing contracts and types:

### Our Contracts (Automated by Hardhat)

- ‚úÖ **ABIs**: Automatically stored in `build/artifacts/` when compiled
- ‚úÖ **Types**: Automatically generated in `build/typechain-types/contracts/` by Hardhat
- ‚úÖ **Zero Configuration**: Just run `npm run compile`

### External Contracts (Managed by Us)

- üìÅ **ABIs**: Stored in `abis/external/` for contracts we interact with
- üîß **Types**: Generated in `build/typechain-types/external/` by our script
- ‚öôÔ∏è **Configuration**: Managed in `config/abis.ts`

### Using Contracts in Code

```typescript
// For our contracts (use Hardhat's generated types)
import { CacheManagerAutomation__factory } from '../build/typechain-types';

const cacheManagerAutomation = CacheManagerAutomation__factory.connect(
  contractAddress,
  signer
);

// For external contracts (use our utilities)
import { getExternalContractInstance } from './config/abis';

const cacheManager = getExternalContractInstance(
  'CacheManager',
  contractAddress,
  signer
);
```

## Architecture Benefits

### Simplified Workflow

- **No Duplication**: Hardhat handles our contracts, we only manage external ones
- **Standard Practice**: Follows Hardhat conventions and best practices
- **Minimal Configuration**: Only configure what's actually needed

### Type Safety

- **Full TypeScript Support**: Types for all contracts (ours + external)
- **Compile-time Validation**: Catch contract interaction errors early
- **IDE Support**: Full autocomplete and type checking

## Testing

The repository includes comprehensive tests for both contracts. Tests are organized into:

- **Integration Tests**: End-to-end functionality testing
- **Unit Tests**: Individual function testing
- **Helper Functions**: Common test utilities

## Deployment

### Local Development

1. Start a local Arbitrum node (if testing against Arbitrum)
2. Configure your environment variables
3. Run deployment:

```bash
npm run deploy:local
```

### Testnet Deployment

1. Configure your private key for testnet deployment
2. Deploy to Arbitrum Sepolia:

```bash
npm run deploy:sepolia
```

### Configuration

Deployment configurations are managed in `config/deployment-config.ts`:

- Network-specific contract addresses
- Gas limits and deployment parameters
- Verification settings

## Architecture

### Non-Upgradeable Design

The contracts use a **non-upgradeable architecture** for security and simplicity:

- Direct contract deployment (no proxy patterns)
- Immutable contract logic once deployed
- Clear ownership and access control patterns

### Type Safety

The repository provides full TypeScript support:

- **Generated types** from all contract ABIs
- **Type-safe contract interactions**
- **Compile-time validation** of contract calls

## Documentation

Detailed documentation for these contracts can be found in:

- The `mkdocs/docs` directory of the arb-research repository
- Local documentation server (follow instructions in arb-research README.md)

## Security

This repository uses OpenZeppelin's battle-tested implementations for:

- Access control (Ownable)
- Reentrancy protection
- Safe math operations
- Escrow functionality

## Contributing

Please refer to the main arb-research repository for contribution guidelines.
